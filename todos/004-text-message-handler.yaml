title: Создать обработчик текстовых сообщений
status: done
created_at: 07.02.2026
completed_at: 07.02.2026

description: |
  Обработчик принимает текстовое сообщение из Telegram,
  отправляет в AgentClient и возвращает ответ пользователю.

recommendation: |
  - src/chat/handlers/text_message_handler.py: TextMessageHandler
    - Реализует IMessageHandler из bot_framework
    - allowed_roles: {"admin"} (только владелец)
    - Зависимости: IAgentClient, IMessageService
    - IMessageService — единый сервис (send + replace + delete)
      из bot_framework, легко переключаться между send и replace
    - В handle():
      1. message_service.send("Думаю...", chat_id)
      2. agent_client.send_message(user_id, text)
      3. message_service.replace(chat_id, message_id, ответ)
  - src/chat/actions/send_to_agent_action.py: SendToAgentAction
    - Зависимость: IMessageService (не отдельные sender/replacer)
    - Инкапсулирует логику отправки в агент и получения ответа
    - Обработка длинных ответов (Telegram лимит 4096 символов — разбить на части)

solution: |
  Создано 3 файла:
  1. src/agent/protocols/i_agent_client.py — Protocol с методом send_message(user_id, text) -> str
  2. src/chat/actions/send_to_agent_action.py — SendToAgentAction: отправка в агент,
     замена "Думаю..." на ответ, разбивка длинных сообщений по 4096 символов (по границе \n)
  3. src/chat/handlers/text_message_handler.py — TextMessageHandler: allowed_roles={"admin"},
     отправляет "Думаю...", делегирует SendToAgentAction
